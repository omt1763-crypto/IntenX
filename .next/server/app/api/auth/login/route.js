"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31415:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>m,patchFetch:()=>_,requestAsyncStorage:()=>d,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var t={};o.r(t),o.d(t,{POST:()=>c});var s=o(49303),i=o(88716),n=o(60670),a=o(87070),l=o(85662),u=o(76706);async function c(e){try{let{email:r,password:o,role:t}=await e.json();if(!r||!o||!t)return a.NextResponse.json({error:"Email, password, and role are required"},{status:400});console.log("[Login] Attempting to authenticate:",{email:r,role:t});let{data:s,error:i}=await l.OQ.auth.signInWithPassword({email:r,password:o});if(i)return console.error("[Login] Auth error:",{message:i.message,code:i.code,status:i.status}),a.NextResponse.json({error:"Invalid email or password. Make sure you signed up first."},{status:401});if(console.log("[Login] Auth successful, user ID:",s.user?.id),!s.user.email_confirmed_at)return console.log("[Login] Email not confirmed for user:",r),a.NextResponse.json({error:"Please confirm your email before logging in. Check your inbox for the verification link.",needsEmailVerification:!0,email:r},{status:403});console.log("[Login] Email confirmed for user:",r);let{data:n,error:c}=await l.pR.from("users").select("*").eq("id",s.user.id),g=null;if(c){console.error("[Login] Profile fetch error:",c),console.log("[Login] Creating missing user profile...");let{data:e,error:r}=await l.pR.from("users").insert([{id:s.user.id,email:s.user.email,first_name:s.user.email.split("@")[0],last_name:"User",role:t||"candidate",password_hash:"MANAGED_BY_SUPABASE_AUTH"}]).select().single();if(r||!e)return console.error("[Login] Failed to create profile:",r),a.NextResponse.json({error:"Failed to setup user profile"},{status:500});g=e}else n&&n.length>0&&(g=n[0]);if(!g)return console.error("[Login] No user profile found or created"),a.NextResponse.json({error:"User profile not found"},{status:404});return console.log("[Login] User profile found, role:",g.role),await (0,u.ag)({userId:s.user.id,action:"login",entityType:"user",entityId:s.user.id,description:`User logged in as ${g.role}`,metadata:{email:s.user.email,role:g.role},ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip"),userAgent:e.headers.get("user-agent")}),await (0,u.Cf)(s.user.id),console.log("[Login] Login activity logged"),a.NextResponse.json({user:g,session:s.session},{status:200})}catch(e){return console.error("Login error:",e),a.NextResponse.json({error:"Failed to login"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\omt91\\Downloads\\main\\interviewverse_frontend\\app\\api\\auth\\login\\route.js",nextConfigOutput:"",userland:t}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:f}=g,m="/api/auth/login/route";function _(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},76706:(e,r,o)=>{o.d(r,{Cf:()=>i,ag:()=>s});var t=o(85662);async function s({userId:e,action:r,entityType:o=null,entityId:s=null,description:i="",metadata:n={},ipAddress:a=null,userAgent:l=null}){try{if(!e||!r){console.warn("[ActivityLog] Missing required fields: userId, action");return}console.log(`[ActivityLog] Logging ${r} for user ${e}`);let{error:u}=await t.pR.from("activity_logs").insert([{user_id:e,action:r,entity_type:o,entity_id:s,description:i,ip_address:a,user_agent:l,metadata:n}]);u?console.error("[ActivityLog] Error logging activity:",u):console.log(`[ActivityLog] âœ… ${r} logged successfully`)}catch(e){console.error("[ActivityLog] Exception:",e)}}async function i(e){try{let{error:r}=await t.pR.from("users").update({last_login_at:new Date().toISOString(),login_count:t.pR.rpc("increment_login_count",{user_id:e})}).eq("id",e);r&&console.error("[LastLogin] Error updating last login:",r)}catch(e){console.error("[LastLogin] Exception:",e)}}},85662:(e,r,o)=>{o.d(r,{OQ:()=>a,pR:()=>l});var t=o(76596);let s=process.env.NEXT_PUBLIC_SUPABASE_URL,i=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,n=process.env.SUPABASE_SERVICE_ROLE_KEY,a=null,l=null;s&&i&&(a=(0,t.eI)(s,i),l=(0,t.eI)(s,n||i))}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[8948,5972,6596],()=>o(31415));module.exports=t})();